

| 存储系统   | 分段                                                         | 内存表                                                       | 提交日志    | 合并                                        | 数据块                                                       |
| ---------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ----------- | ------------------------------------------- | ------------------------------------------------------------ |
| HBase      | HFile文件(Immutable)<br />完整写一个新文件，顺序写           | MemStore                                                     | WAL(顺序写) | Compaction                                  | 默认64KB<br />查询时是将整个Block加载到内存<br />数据块会缓存在Block Cache |
| Clickhouse | 数据判断文件<br />例如：199505_1_1_0<br />199505_3_3_0       |                                                              |             | Merge<br />将多个数据片段文件合并成一个文件 |                                                              |
| ES         | Segment<br />Commit Point<br />Commit Point记录了有哪些segment<br />Segment也是Immutable的 | 索引缓存                                                     | Translog    | 后台定期将多个Segment合并成一个             |                                                              |
| MySQL      |                                                              | Buffer Pool<br />当查询数据时，会先从内存中的Buffer Pool中查询。如果Buffer Pool中不存在，存储引擎会先将页面加载到Buffer Pool中，然后将数据返回给客户端。<br />更新数据的时候，也会先将数据所在页加载到Buffer Pool，然后先修改内存中的数据。被修改的数据会在之后统一flush到磁盘。 | WAL         | 无                                          | 页，默认16KB<br />将一整个页面从磁盘读取到内存<br />buffer pool中存储的基本单位是页 |

## 各个存储系统处理数据读写过程都很相似

在数据写入过程中，都是只有顺序写，没有随机写。

写数据时都是先提交日志文件WAL(Translog)，然后只是修改内存中的数据，使得后续的数据查询可以从内存中获取到。当内存中的数据达到一定量时，再一次flush到文件中。如果中间过程发生异常，可以通过提交日志文件进行恢复。

HBase、ES、Clickhouse都会将一个分区(shard、region)内的数据分成多个Segment，在Hbase中Segment就是一个个HFile，在ES中就叫作Segment文件，在Clickhouse对应一个个形如199505_1_1_0的目录。每个Segment都是Immutable的，即数据写入到Segment后就不能再被修改了。

所有的数据写入，包括删除，都是写入一个数据的新版本，数据的新版本会添加到一个新的Segment中。

在后台有一个程序会定期地进行类似于“垃圾回收”的操作，通过合并多个Segment，清理掉版本过期的数据和被标记为删除的数据。

在读取数据的时候，其实是读取内存(MemStore)加上**多个**Segment文件合并在一起的一个视图。也就是说，从MemStore和**所有**HFile文件中，拿到对应行键的全部数据之后，会在内存中合并数据，并根据时间戳或者墓碑标记，对数据进行“修改”和“删除”，并将修改后的数据返回给到客户端。

## WAL全称

Write Ahead Log 

## Mysql

Mysql没有后台线程自动执行“垃圾回收”，所以除非有新记录可以重用被删除记录所在的磁盘空间，否则被删除的记录会永远留在磁盘上。

## Mysql优化

1. explain 

2. profile

3. 避免回表，将所需的所有列都包含在二级索引中
4. 明确指定要使用的索引，避免在分析过程中耗费更多的分析时间
5. 索引的区分度要够高，区分度不够高还不如不用索引。因为二级索引还要回表，回表会导致大量的随机读写。
6. 

